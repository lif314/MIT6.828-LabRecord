# Lab 6: Network Driver

# Introduction

既然你有一个文件系统，任何自尊的操作系统都不应该没有网络堆栈。在本实验中，您将编写网络接口卡的驱动程序。该卡将基于英特尔 82540EM 芯片，也称为 E1000。

### Getting Started

但是，网卡驱动程序不足以让您的操作系统连接到 Internet。在新的 lab6 代码中，我们为您提供了一个网络堆栈和一个网络服务器。与之前的实验一样，使用 git 获取本实验的代码，合并到您自己的代码中，并探索新 net/ 目录的内容以及 kern/ 中的新文件。

除了编写驱动程序之外，您还需要创建一个系统调用接口来访问您的驱动程序。您将实现缺少的网络服务器代码以在网络堆栈和驱动程序之间传输数据包。您还将通过完成 Web 服务器将所有内容联系在一起。使用新的 Web 服务器，您将能够从您的文件系统提供文件。

大部分内核设备驱动程序代码都需要您自己从头开始编写。本实验提供的指导比以前的实验少得多：没有骨架文件，没有一成不变的系统调用接口，许多设计决策由您决定。出于这个原因，我们建议您在开始任何单独的练习之前阅读整个作业。许多学生发现这个实验比以前的实验更难，所以请相应地计划你的时间。

## QEMU's virtual network

我们将使用 QEMU 的用户模式网络堆栈，因为它不需要管理权限即可运行。 QEMU 的文档在这里有更多关于 user-net 的信息。我们更新了 makefile 以启用 QEMU 的用户模式网络堆栈和虚拟 E1000 网卡。

默认情况下，QEMU 提供了一个运行在 IP 10.0.2.2 上的虚拟路由器，并将为 JOS 分配 IP 地址 10.0.2.15。为了简单起见，我们将这些默认值硬编码到 net/ns.h 中的网络服务器中。

虽然 QEMU 的虚拟网络允许 JOS 与 Internet 进行任意连接，但 JOS 的 10.0.2.15 地址在 QEMU 内部运行的虚拟网络之外没有任何意义（即 QEMU 充当 NAT），因此我们无法直接连接到服务器在 JOS 内部运行，甚至从运行 QEMU 的主机运行。为了解决这个问题，我们将 QEMU 配置为在主机上的某个端口上运行一个服务器，该服务器只需连接到 JOS 中的某个端口，并在您的真实主机和虚拟网络之间来回传输数据。

您将在端口 7 (echo) 和 80 (http) 上运行 JOS 服务器。为避免共享 Athena 机器上的冲突，makefile 会根据您的用户 ID 为这些机器生成转发端口。要找出 QEMU 在您的开发主机上转发到哪些端口，请运行 make which-ports。为方便起见，makefile 还提供了 make nc-7 和 make nc-80，它们允许您直接与在终端中的这些端口上运行的服务器进行交互。 （这些目标仅连接到正在运行的 QEMU 实例；您必须单独启动 QEMU 本身。）



### Packet Inspection

https://qiita.com/kagurazakakotori/items/a7d93161f733d5800517

https://www.cnblogs.com/gatsby123/p/9950705.html

https://www.dingmos.com/2020/07/28/33.html

https://blog.csdn.net/He11o_Liu/article/details/77887505

